name: All tests

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Unit tests
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
    - name: Install Leiningen
      run: |
        curl -fsSL https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein -o lein
        chmod +x lein
        sudo mv lein /usr/local/bin/lein
        lein version
    - name: Cache repository
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-${{ hashFiles('**/project.clj') }}
        restore-keys: |
          ${{ runner.os }}-
    - name: Install dependencies
      run: lein deps
    - name: Run tests
      run: lein test

  integration-postgres:
    runs-on: ubuntu-latest
    name: Integration tests (PostgreSQL)
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      SCARAB_TEST_STORAGE: jdbc
      SCARAB_TEST_CONTACT_POINTS: jdbc:postgresql://localhost:5432/postgres
      SCARAB_TEST_USERNAME: postgres
      SCARAB_TEST_PASSWORD: postgres
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
    - name: Install Leiningen
      run: |
        curl -fsSL https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein -o lein
        chmod +x lein
        sudo mv lein /usr/local/bin/lein
        lein version
    - name: Cache repository
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-${{ hashFiles('**/project.clj') }}
        restore-keys: |
          ${{ runner.os }}-
    - name: Install dependencies
      run: lein deps
    - name: Write ScalarDB properties
      run: |
        cat <<'EOF' > .github/scalardb/database.properties
        scalar.db.storage=jdbc
        scalar.db.contact_points=jdbc:postgresql://localhost:5432/postgres
        scalar.db.username=postgres
        scalar.db.password=postgres
        EOF
    - name: Wait for PostgreSQL
      run: |
        for i in {1..30}; do
          (echo > /dev/tcp/localhost/5432) >/dev/null 2>&1 && exit 0
          sleep 2
        done
        echo "PostgreSQL did not become ready in time" >&2
        exit 1
    - name: Load ScalarDB schema
      run: |
        docker run --rm \
          --network host \
          -v "$PWD/.github/scalardb:/scalardb/schema" \
          ghcr.io/scalar-labs/scalardb-schema-loader:3.17.1 \
          --config /scalardb/schema/database.properties \
          --schema-file /scalardb/schema/schema.json \
          --coordinator true
    - name: Run integration tests
      run: lein test :integration
